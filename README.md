# easy_microbiome
## 基于扩增子测序的全套数据处理和分析流程
做了这么多的扩增子数据分析了，到目前作分析使用的工具在不断更新，选择也越来越大了，所以挑选适合自己的，符合自己思维习惯，分析习惯的工具也就成为了提上日程的问题。
下面是我的分析习惯所形成的一整套体系：

95%基于R语言的全套扩增子数据处理和下游分析流程。（目前我正在将Gephi的网络布局算法调整到R包igraph输出layout，但是目前未在R中，sparcc网络构建未在R中）

 本次教程实例选用了24个扩增子16s样品，这些样品来源于NCBI公开的数据，项目号为：PRJNA495669；（可以直接下载）；mapping文件为分组文件，修改自该项目的说明文件。不可纠结分组。这个项目有细菌真菌数据同时可用，方便我进行细菌真菌群落的联合分析。同时我人工编纂了一套非靶向代谢组学数据，进行扩增子细菌真菌群落联合代谢组学分析。
 

基于ubuntu下安装的rstudio可以在同一个界面进行bash命令的输入，这一改进方便了我使用bash当胶水的使用。


##### 本教程特色

Qiime2将dada2进行了封装，这里我们使用的是R语言本尊进行dada2数据流程；本流程提供从原始数据到OTU表格，注释文件，进化树的全套构建过程，并支持一键得到结果。将结果整合为phyloseq的输入；
官方help文件地址：  本教程相比于官方指导文件，修改了许多内容，如下：
- 使用big date策略，逐个测序文件分析，使得在即使只有8G的笔记本上也可以轻松跑完超过10G的扩增子样品。
- 构造并优化追踪文件，使得每个步骤的序列数量清晰呈现。
- 使用两种方式进行注释，在注释到种的时候可能会出现内存不够（8G一下内存）的情况，优化代码，使得可以在内存不够的情况下顺利完成。
- R语言构建进化树，这里进化树的构建时间相对较长，如果在win上，使用单线程的话会耗费一定的时间，所以我提供R语言转化的代表序列文件，并支持外部命令构建进化树（Fastree）。




### 1. 基于R语言的 DADA2 处理流程实战（完成）
### DADA2处理须知
一键分析要求：
1. 双端测序文件；
2. 序列前后端标识为_1和_2;(NCBI下载数据默认格式，可以自己修改标识符号，或者等我收集了足够的标识，便可以做一个判断的自动识别)


### 2. 基于群落数据提供基于样品和OTU的多种过滤方式及其群落总体统计（完成）
- 提供多种传统流程转化phyloseq的方式，方便使用后续流程。
- 提供将追踪序列文件可视化的代码；
- 基于phyloseq对样品和OTU使用多种标准进行过滤（目前是我见过最为方便的过滤方式）；
- 使用代码直接书写文章中扩增子部分结果分析的基本统计部分的段落内容。


###  3. 基于OTU table的基本分析（alpha+排序+门类堆叠+核心OTU）（完成）
- 基于alpha多样性提供phyloseq，microbiome的一共32中alpha多样性指标的计算和出图，提供使用microbiomeSeq的alpha出图（可以直接进行差异分析并展示在alpha图形上）
- 基于排序提供基于microbiomeSeq的排序（特点是可以直接进行置换检验，设置直接进行两两置换检验，展示到排序图中，并提供结果提取。）基于phyloseq的排序，我编写置换检验过程，并自动化添加到图形；
- 门类丰度堆叠柱状图的绘制提供冲击图样式，并可以自行制定分类等级来绘制不同分类等级的堆叠柱状图（这部分提供将图片字体修改为新罗马的方式，并制定为默认方式）；
- 韦恩图部分展示共有和特有OTU信息，我强化温恩图，使得自动识别分组，并自动出图，极大的简化的韦恩图的绘制过程，提供upset出图形式。
- 提供基本图形组合。


#### 3.1 alpha多样性强化分析（完成）
- 提供32中alpha指标的计算和出图；
- 纳入支配物种多样性和稀有物种多样性指标计算和出图；

#### 3.2 beta多样性强化分析（完成）
- 基于多种距离的多种排序方法的运算和比对
- 基于群落之间差异的多种显著性方法检验

#### 3.3 不同分类等级物种丰度可视化强化分析（完成）
- 提供不同不同等级的物种丰度柱状图和冲击图的绘制（设置丰度过滤标准），并设置循环自动出图六个不同等级的门类图片。
- 提供特定的门类丰度可视化方案。

#### 3.4 韦恩图的强化分析（完成）
- 对温恩图每个部分OTU统计其在总的otu table中占的比例，并统计检验。（一键分析）
- 提供韦恩图每个部分OTU的门类及其丰度可视化方案（柱状图和冲击图）；（指定区域，自动出图）。
- R语言提供二分网络的分析，并完全借入Gephi，实现漂亮出图。
- （R语言整合（Gephi可视化方案正在构建中）


### 4. 基于OTU table的进一步分析（DEsep差异+随机森林）（正在···）

- 基于otu水平做差异分析（使用DEsep2方法）；
- 使用随机森林监督分类，交叉检验并自动判断重要变量，挑选可视化
- 从挑选出的重要变量中进一步使用Desep结果判断是否存在差异，挑选差异物种展示（火柴棒图），丰度展示（热图）

存在问题：deSep标准化出现问题，不过这是有可能的？？等待解决



#### 4.1 基于OTU table 进一步强化差异分析（等待）
- 自动化运行基于标准化的不同分类水平的OTU 表格的Desep2和edger差异分析，输出表格（两组）
- 自动化基于相对丰度的不同分类水平差异分析，输出表格。（两组）
- 基于相对丰度，多个分组的OTU进行非参数检验并两两检验的探索


#### 4.2 机器学习在群落数据中的应用（等待）
- 贝叶斯
- 多元回归树
- K-mean
- 决策树


### 5 基于群落数据的相关分析（正在···）
- 提供样品聚类分析（完成）
- 群落同环境因子的相关（RDA，CCA）（完成）
- 群落指定特定的OTU之间相关；基于不同分类水平做相关分析。（完成）
- 环境数据同alpha多样性关系（相关性点矩阵）（···）
- 方差分解分析（···）


存在问题：环境变量同OTU相关出现问题？等待解决


### 6. 基于R语言的OTU网络全套解决方案（完成）
- 基于phyloseq构建OTU表格矩阵，高中低丰度矩阵（设定阈值）；自动化输出；
- 基于sparcc网络矩阵构建，自动化编写代码运行Sparcc分析；
- 基于igraph网络可视化（强化节点边框宽度的设置；不同分组自动出图；
- -高丰度，中丰度，低丰度网络构建及其可视化，细化群落物种关系。
- 自动化分析网络属性，节点属性，构建随机网络计算随机网络属性。
- 自动化计算正负相关数量，分区段可视化不同网络相关值大小。总结正负相关数量以及在网络中占有比例。



#### 6.1 基于网络之间的比对方案（等待）
- 网络模块化分析及其可视化；基于microbiomeSeq的网络ZI-PI计算及其可视化。hub节点挑选；
- 基于两个网络比对共有节点和特有节点，绘制韦恩图可视化；
- 基于共有节点和特有节点之间的关系，进行子网络提取及其可视化。
- 共有节点和特有节点之间的相关关系提取，进行共有OTU的特有otu之间关系强弱的分析。



### 7. Graphlan绘制进化树和物种分类树

#### 7.1  物种分类树构建及其群落多数据整合（完成）
- 基于物种分类树的R语言构建；提供从phyloseq直接得到graphlan输入的物种分类树文件。
- 通过graphlan外环整合不同分组物种丰度信息，随机森林结果等




#### 7.2 物种进化树构建及群落多数据整合（等待）
- 基于phyloseq按照不同分类等级对进化树进行合并，可视化。
- 基于进化树的Graphlan可视化。
- 通过外环整合群落多数据结果。


### 8 基于phyloseq构建lefse分析输入文件并完成lefse分析（完成）
- 基于OTU水平的lefse的完整分析流程
- 基于属水平的lefse完整分析流程
